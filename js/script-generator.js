// Script Generator JavaScript

let generatedScripts = [];

// Generate script using Gemini API
async function generateScript() {
  const platform = document.getElementById('platform').value;
  const topic = document.getElementById('topic').value;
  const duration = document.getElementById('duration').value;
  const tone = document.getElementById('tone').value;
  const language = document.getElementById('language').value;

  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout

    const response = await fetch('http://localhost:3000/api/generate-script', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ platform, topic, duration, tone, language }),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    if (!response.ok) throw new Error('API Error');
    const data = await response.json();
    
    // Handle nested JSON structure from Gemini
    let scriptData = data.script;
    
    // If the response is a string, parse it
    if (typeof scriptData === 'string') {
      try {
        scriptData = JSON.parse(scriptData);
      } catch (e) {
        // If parsing fails, just use the string
      }
    }
    
    // Extract text from nested objects
    const hookText = scriptData.hook?.script || scriptData.hook || 'Hook not generated';
    const mainText = scriptData.main_content?.script || scriptData.main_content || scriptData.content || 'Content not generated';
    const ctaText = scriptData.cta?.script || scriptData.cta || 'Call to action not generated';
    const tipsText = scriptData.tips?.script || scriptData.tips || 'Tips not available';
    
    return {
      hook: hookText,
      main: mainText,
      cta: ctaText,
      tips: tipsText
    };
  } catch (error) {
    console.error('Script generation error:', error);
    if (error.name === 'AbortError') {
      window.creatorHub.showNotification('Request timeout. Please try again.', 'error');
    } else {
      window.creatorHub.showNotification('Error generating script. Please check the server.', 'error');
    }
    return null;
  }
}

// Display generated script
function displayScript(script) {
  document.getElementById('hookOutput').textContent = script.hook;
  document.getElementById('mainOutput').textContent = script.main;
  document.getElementById('ctaOutput').textContent = script.cta;
  document.getElementById('tipsOutput').textContent = script.tips;

  document.getElementById('scriptOutput').classList.remove('hidden');
  document.getElementById('emptyState').classList.add('hidden');
  document.getElementById('loadingSpinner').classList.add('hidden');

  showActionButtons();
}

// Show action buttons
function showActionButtons() {
  document.getElementById('copyBtn').style.display = 'inline-block';
  document.getElementById('downloadBtn').style.display = 'inline-block';
  document.getElementById('regenerateBtn').style.display = 'inline-block';
}

// Copy to clipboard
function copyScript() {
  const hook = document.getElementById('hookOutput').textContent;
  const main = document.getElementById('mainOutput').textContent;
  const cta = document.getElementById('ctaOutput').textContent;
  const text = `HOOK:\n${hook}\n\nMAIN CONTENT:\n${main}\n\nCTA:\n${cta}`;

  navigator.clipboard.writeText(text).then(() => {
    window.creatorHub.showNotification('Script copied to clipboard!', 'success');
  });
}

// Download as text file
function downloadScript() {
  const hook = document.getElementById('hookOutput').textContent;
  const main = document.getElementById('mainOutput').textContent;
  const cta = document.getElementById('ctaOutput').textContent;
  const tips = document.getElementById('tipsOutput').textContent;

  const content = `SCRIPT GENERATED BY CREATORHUB\n${'='.repeat(40)}\n\nHOOK (First 3 seconds):\n${hook}\n\nMAIN CONTENT:\n${main}\n\nCTA (Call to Action):\n${cta}\n\nTIPS:\n${tips}`;

  const blob = new Blob([content], { type: 'text/plain' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `script-${Date.now()}.txt`;
  a.click();
  window.URL.revokeObjectURL(url);
  window.creatorHub.showNotification('Script downloaded!', 'success');
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  const scriptForm = document.getElementById('scriptForm');
  const copyBtn = document.getElementById('copyBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const regenerateBtn = document.getElementById('regenerateBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  if (scriptForm) {
    scriptForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Show loading
      document.getElementById('scriptOutput').classList.add('hidden');
      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('loadingSpinner').classList.remove('hidden');

      // Call Gemini API
      const script = await generateScript();
      
      // Always hide loading spinner
      document.getElementById('loadingSpinner').classList.add('hidden');
      
      if (script) {
        generatedScripts.push({
          id: generatedScripts.length + 1,
          platform: document.getElementById('platform').value,
          topic: document.getElementById('topic').value,
          ...script,
          timestamp: new Date()
        });

        displayScript(script);
        renderHistory();
      } else {
        // Show empty state if error
        document.getElementById('emptyState').classList.remove('hidden');
      }
    });
  }

  if (copyBtn) copyBtn.addEventListener('click', copyScript);
  if (downloadBtn) downloadBtn.addEventListener('click', downloadScript);
  if (regenerateBtn) {
    regenerateBtn.addEventListener('click', () => {
      document.getElementById('scriptForm').dispatchEvent(new Event('submit'));
    });
  }

  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('authToken');
      localStorage.removeItem('user');
      window.location.href = '../index.html';
    });
  }

  renderHistory();
});

// Render history
function renderHistory() {
  const historyList = document.getElementById('historyList');
  historyList.innerHTML = '';

  if (generatedScripts.length === 0) {
    historyList.innerHTML = '<p style="color: var(--text-light); opacity: 0.6; grid-column: 1/-1;">No scripts generated yet</p>';
    return;
  }

  generatedScripts.slice().reverse().forEach(script => {
    const card = document.createElement('div');
    card.className = 'history-card';
    card.innerHTML = `
      <div class="history-card-header">
        <h3 class="history-card-title">${script.topic}</h3>
      </div>
      <div class="history-card-meta">
        <span>ðŸ“± ${script.platform}</span> â€¢ <span>${script.timestamp.toLocaleDateString()}</span>
      </div>
      <p class="history-card-preview">${script.main}</p>
      <div class="history-card-actions">
        <button class="btn btn-secondary" onclick="loadScript(${script.id})">View</button>
        <button class="btn btn-primary" onclick="useScript(${script.id})">Use</button>
      </div>
    `;
    historyList.appendChild(card);
  });
}

function loadScript(id) {
  const script = generatedScripts.find(s => s.id === id);
  if (script) {
    document.getElementById('hookOutput').textContent = script.hook;
    document.getElementById('mainOutput').textContent = script.main;
    document.getElementById('ctaOutput').textContent = script.cta;
    document.getElementById('tipsOutput').textContent = script.tips;
    document.getElementById('scriptOutput').classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

function useScript(id) {
  loadScript(id);
  window.creatorHub.showNotification('Script loaded! Ready to use.', 'success');
}
